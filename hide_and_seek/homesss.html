<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>任务倒计时与文件上传</title>
    <style>
        #timer {
            font-size: 20px;
            color: red;
            margin-top: 10px;
        }
        .image-preview img {
            max-width: 100px;
            max-height: 100px;
            margin-top: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <h1>任务与文件上传</h1>
    <div id="namePrompt">
        <input type="text" id="nameInput" placeholder="请输入名称">
        <button id="submitName">确认名称</button>
    </div>
    <button id="logoutButton" style="display:none;">登出</button>
    <div id="taskList" style="display:none;">
        <h2>任务列表</h2>
        <ul id="tasks"></ul>
        <p id="taskCountdown"></p>
    </div>
    <form id="uploadForm" style="display: none;">
        <input type="file" id="fileInput" accept="" multiple required>
        <div class="image-preview" id="imagePreview"></div>
        <button type="submit" id="uploadButton">上传</button>
    </form>
</form>
    <p id="responseMessage" style="margin-top: 20px;"></p>

    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.3.0/dist/av-min.js"></script>
    <script>
        // 初始化LeanCloud
        AV.init({
            appId: 'a4O2WP8ZKjkOH8RbLNXgLTAE-gzGzoHsz',
            appKey: 'At7BrmqGKGPqcbHXwtEL6Y3e',
            serverURLs: 'https://a4o2wp8z.lc-cn-n1-shared.com',
        });

        const namePrompt = document.getElementById('namePrompt');
        const nameInput = document.getElementById('nameInput');
        const submitNameButton = document.getElementById('submitName');
        const logoutButton = document.getElementById('logoutButton');
        const taskListDiv = document.getElementById('taskList');
        const tasksList = document.getElementById('tasks');
        const taskCountdownDisplay = document.getElementById('taskCountdown');
        const uploadForm = document.getElementById('uploadForm');
        const fileInput = document.getElementById('fileInput');
        const imagePreview = document.getElementById('imagePreview');
        const uploadButton = document.getElementById('uploadButton');
        const responseMessage = document.getElementById('responseMessage');

        let userName = localStorage.getItem('userName');
        let currentTask = null; // 当前任务
        let currentTaskEndTime;
        let countdownTimer;

        // 处理名称提交
        submitNameButton.addEventListener('click', async () => {
            const name = nameInput.value.trim();
            if (name) {
                try {
                    const query = new AV.Query('person');
                    query.equalTo('name', name);
                    const results = await query.find();
                    if (results.length > 0) {
                        localStorage.setItem('userName', name);
                        userName = name;
                        namePrompt.style.display = 'none';
                        logoutButton.style.display = 'inline-block';
                        loadTasks();
                    } else {
                        alert('名称未在系统中找到！');
                    }
                } catch (error) {
                    alert('获取数据失败，请重试');
                }
            }
        });

        // 登出功能
        logoutButton.addEventListener('click', () => {
            localStorage.removeItem('userName');
            userName = null;
            namePrompt.style.display = 'block';
            logoutButton.style.display = 'none';
            taskListDiv.style.display = 'none';
        });

        // 加载任务
        async function loadTasks() {
            try {
                const query = new AV.Query('tasks');
                const tasks = await query.find();
                tasksList.innerHTML = ''; // 清空现有任务列表
                tasks.forEach(task => {
                    const listItem = document.createElement('li');
                    const taskPerson = task.get('person');
                    const taskStart = task.get('start');
                    const taskEnd = task.get('end');
                    const taskLocation = task.get('location');

                    if (taskPerson === userName) {
                        const taskDetails = `任务：${taskLocation}，开始时间：${taskStart}，结束时间：${taskEnd}，人物：${taskPerson}`;
                        listItem.innerText = taskDetails;
                        tasksList.appendChild(listItem);
                        currentTask = task;

                        // 设置倒计时
                        const currentTime = new Date().getTime();
                        if (currentTime >= new Date(taskStart).getTime()) {
                            const audio = new Audio('../resource/alarm-beep-electronic-91914.mp3');
                            audio.play();
                            currentTaskEndTime = new Date(taskEnd).getTime();
                            startTaskCountdown();
                        }
                    }
                });

                taskListDiv.style.display = 'block';
            } catch (error) {
                alert('加载任务失败，请重试');
            }
        }

        // 开始任务倒计时
        function startTaskCountdown() {
            countdownTimer = setInterval(() => {
                const remainingTime = currentTaskEndTime - new Date().getTime();
                if (remainingTime <= 0) {
                    clearInterval(countdownTimer);
                    taskCountdownDisplay.textContent = '任务已结束';
                    uploadForm.style.display = 'none'; // 结束后禁用上传功能
                } else {
                    const minutes = Math.floor(remainingTime / 60000);
                    const seconds = Math.floor((remainingTime % 60000) / 1000);
                    taskCountdownDisplay.textContent = `距离结束：${minutes}:${seconds < 10 ? '0' + seconds : seconds}`;
                    uploadForm.style.display = 'block'; // 任务期间显示上传功能
                }
            }, 1000);
        }

        // 定期检查任务列表，自动触发任务倒计时
        setInterval(loadTasks, 3000); // 每1分钟重新加载任务列表

        // 文件选择后显示缩略图
        fileInput.addEventListener('change', () => {
            imagePreview.innerHTML = '';
            for (let file of fileInput.files) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    imagePreview.appendChild(img);
                };
                reader.readAsDataURL(file);
            }
        });
        
        // 点击上传按钮并完成任务
        // 用户输入 location 并获取对应的任务
        const locationInput = document.getElementById('locationInput');
        const completeTaskButton = document.getElementById('completeTaskButton');

        completeTaskButton.addEventListener('click', async () => {
            const location = locationInput.value.trim();
            if (!location) {
                alert('请输入任务地点');
                return;
            }

            try {
                // 查询该地点的任务
                const TaskQuery = new AV.Query('tasks');
                TaskQuery.equalTo('location', location);
                const taskResults = await TaskQuery.find();

                if (taskResults.length === 0) {
                    alert('该地点没有任务');
                    return;
                }

                // 检查任务是否处于完成的时间区间
                const currentTime = new Date().getTime();
                let taskToComplete = null;
                for (let task of taskResults) {
                    const taskStart = new Date(task.get('start')).getTime();
                    const taskEnd = new Date(task.get('end')).getTime();

                    // 如果当前时间在任务的时间区间内，选中该任务
                    if (currentTime >= taskStart && currentTime <= taskEnd) {
                        taskToComplete = task;
                        break;
                    }
                }

                if (taskToComplete) {
                    currentTask = taskToComplete; // 设置 currentTask
                    alert('任务选中，可以开始上传文件');
                } else {
                    alert('当前时间不在任务的有效时间内');
                }

            } catch (error) {
                alert('加载任务失败，请重试');
            }
        });

        // 修改文件输入：限制为选择单个文件
        // 允许选择多个文件
        fileInput.setAttribute('multiple', true);

        // 点击上传按钮并完成任务
        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!currentTask) {
                alert('请先选择任务');
                return;
            }

            if (fileInput.files.length === 0) {
                alert('请选择文件');
                return;
            }

            // 文件大小检查
            if ([...fileInput.files].some(file => file.size > 25 * 1024 * 1024)) {
                alert('文件大小不能超过25MB');
                return;
            }

            responseMessage.innerText = '上传中，请稍等...';

            try {
                // 获取 Round 类中最大的 times 值
                const RoundQuery = new AV.Query('Round');
                RoundQuery.descending('times');
                const roundResult = await RoundQuery.first();
                const maxTimes = roundResult ? roundResult.get('times') : 0;

                // 遍历每个文件进行上传
                for (let file of fileInput.files) {
                    // 构造文件名
                    const fileName = `Round${maxTimes}_location_${userName}_${currentTask.get('location')}`;

                    const formData = new FormData();
                    formData.append('key', 'chv_hk8l_b4e3a5f15c38c5eace95dd4f31c826706862c5711d157843350b40b1fdee9e86184567db07ee2e55ff3c5c2d000629e2593c43381d2598fdaf8d51172237f41b');
                    formData.append('album_id', 'SK5pJ');
                    formData.append('source', file);
                    formData.append('title', fileName);

                    // 上传文件
                    await fetch('https://www.picgo.net/api/1/upload', {
                        method: 'POST',
                        mode: 'no-cors',
                        body: formData,
                    });

                    // 上传成功日志
                    const MyLog = AV.Object.extend('myLog');
                    const log = new MyLog();
                    log.set('person', userName);
                    log.set('content', `文件上传成功：${fileName}`);
                    await log.save();
                }

                // 记录完成任务日志
                const completeLog = new MyLog();
                completeLog.set('person', userName);
                completeLog.set('content', `${userName}已经完成${currentTask.get('location')}`);
                await completeLog.save();

                // 删除任务
                await currentTask.destroy();

                // 提示任务完成
                alert('所有文件上传成功！任务已完成！');

                // 禁用上传功能
                uploadForm.style.display = 'none';
                clearInterval(countdownTimer);
                taskCountdownDisplay.textContent = '';

            } catch (error) {
                responseMessage.innerText = '上传或完成任务失败，请重试！';
            }
        });

        // 如果本地存储有名称，则直接加载任务
        if (userName) {
            loadTasks();
            namePrompt.style.display = 'none';
            logoutButton.style.display = 'inline-block';
        }
    </script>
</body>
</html>
