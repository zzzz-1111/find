<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>任务倒计时与文件上传</title>
    <style>
        #timer {
            font-size: 20px;
            color: red;
            margin-top: 10px;
        }
        .image-preview img {
            max-width: 100px;
            max-height: 100px;
            margin-top: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <h1>任务与文件上传</h1>
    <div id="namePrompt">
        <input type="text" id="nameInput" placeholder="请输入名称">
        <button id="submitName">确认名称</button>
    </div>
    <button id="logoutButton" style="display:none;">登出</button>
    <div id="taskList" style="display:none;">
        <h2>任务列表</h2>
        <ul id="tasks"></ul>
        <p id="taskCountdown"></p>
    </div>
    <form id="uploadForm" style="display: none;">
        <input type="file" id="fileInput" accept="" multiple required>
        <div class="image-preview" id="imagePreview"></div>
        <button type="submit" id="uploadButton">上传</button>
    </form>
</form>
    <p id="responseMessage" style="margin-top: 20px;"></p>

    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.3.0/dist/av-min.js"></script>
    <script>
        // 初始化LeanCloud
        AV.init({
            appId: 'a4O2WP8ZKjkOH8RbLNXgLTAE-gzGzoHsz',
            appKey: 'At7BrmqGKGPqcbHXwtEL6Y3e',
            serverURLs: 'https://a4o2wp8z.lc-cn-n1-shared.com',
        });

        const namePrompt = document.getElementById('namePrompt');
        const nameInput = document.getElementById('nameInput');
        const submitNameButton = document.getElementById('submitName');
        const logoutButton = document.getElementById('logoutButton');
        const taskListDiv = document.getElementById('taskList');
        const tasksList = document.getElementById('tasks');
        const taskCountdownDisplay = document.getElementById('taskCountdown');
        const uploadForm = document.getElementById('uploadForm');
        const fileInput = document.getElementById('fileInput');
        const imagePreview = document.getElementById('imagePreview');
        const uploadButton = document.getElementById('uploadButton');
        const responseMessage = document.getElementById('responseMessage');

        let userName = localStorage.getItem('userName');
        let currentTask = null; // 当前任务
        let currentTaskEndTime;
        let countdownTimer;

        // 处理名称提交
        submitNameButton.addEventListener('click', async () => {
            const name = nameInput.value.trim();
            if (name) {
                try {
                    const query = new AV.Query('person');
                    query.equalTo('name', name);
                    const results = await query.find();
                    if (results.length > 0) {
                        localStorage.setItem('userName', name);
                        userName = name;
                        namePrompt.style.display = 'none';
                        logoutButton.style.display = 'inline-block';
                        loadTasks();
                    } else {
                        alert('名称未在系统中找到！');
                    }
                } catch (error) {
                    alert('获取数据失败，请重试');
                }
            }
        });

        // 登出功能
        logoutButton.addEventListener('click', () => {
            localStorage.removeItem('userName');
            userName = null;
            namePrompt.style.display = 'block';
            logoutButton.style.display = 'none';
            taskListDiv.style.display = 'none';
        });

        // 加载任务
        async function loadTasks() {
    try {
        const query = new AV.Query('tasks');
        query.ascending('start'); // 按开始时间升序排列
        const tasks = await query.find();
        tasksList.innerHTML = ''; // 清空现有任务列表
        currentTask = null;

        const currentTime = new Date().getTime();
        let nextTask = null;

        for (const task of tasks) {
            const taskPerson = task.get('person');
            const taskStart = new Date(task.get('start')).getTime();
            const taskEnd = new Date(task.get('end')).getTime();
            const taskLocation = task.get('location');

            // 检查是否是当前用户的任务
            if (taskPerson === userName) {
                if (currentTime >= taskStart && currentTime <= taskEnd) {
                    // 当前时间在任务起止范围内，设置为当前任务
                    currentTask = task;
                    const taskDetails = `任务：${taskLocation}，开始：${formatTime(task.get('start'))}，结束：${formatTime(task.get('end'))}`;
                    const listItem = document.createElement('li');
                    listItem.innerText = taskDetails;
                    tasksList.appendChild(listItem);

                    // 播放提醒声音
                    const audio = new Audio('../resource/alarm-beep-electronic-91914.mp3');
                    audio.play();

                    // 设置倒计时
                    currentTaskEndTime = taskEnd;
                    startTaskCountdown();
                } else if (currentTime > taskEnd) {
                    // 当前任务已经过了结束时间，发送未完成日志并删除任务
                    const MyLog = AV.Object.extend('myLog');
                    const log = new MyLog();
                    log.set('content', `任务 ${taskLocation} 未被 ${userName} 完成`);
                    await log.save();

                    // 删除过期任务
                    await task.destroy();
                } else if (!nextTask && taskStart > currentTime) {
                    // 记录下一个任务
                    nextTask = task;
                }
            }
        }

        // 如果没有当前任务，显示下一个任务的预告和倒计时
        if (!currentTask && nextTask) {
            const nextTaskDetails = `下一个任务：${nextTask.get('location')}，开始时间：${formatTime(nextTask.get('start'))}`;
            const listItem = document.createElement('li');
            listItem.innerText = nextTaskDetails;
            tasksList.appendChild(listItem);

            // 设置下一个任务的倒计时
            const nextTaskStartTime = new Date(nextTask.get('start')).getTime();
            const countdownElement = document.createElement('p');
            countdownElement.id = 'nextTaskCountdown';
            tasksList.appendChild(countdownElement);

            startNextTaskCountdown(nextTaskStartTime);
        } else if (!currentTask) {
            // 如果没有任务
            const noTaskMessage = document.createElement('li');
            noTaskMessage.innerText = '当前没有进行中的任务，也没有安排下一个任务。';
            tasksList.appendChild(noTaskMessage);
        }

        taskListDiv.style.display = 'block';
    } catch (error) {
        console.error('加载任务失败:', error);
        alert('加载任务失败，请重试');
    }
}


        // 格式化时间，仅显示小时:分钟
        function formatTime(dateString) {
            const date = new Date(dateString);
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${hours}:${minutes}`;
        }

        // 开始下一个任务的倒计时
        function startNextTaskCountdown(nextTaskStartTime) {
            const countdownElement = document.getElementById('nextTaskCountdown');
            const timer = setInterval(() => {
                const currentTime = new Date().getTime();
                const remainingTime = nextTaskStartTime - currentTime;

                if (remainingTime <= 0) {
                    clearInterval(timer);
                    countdownElement.textContent = '下一个任务已开始！';
                    loadTasks();
                } else {
                    const hours = Math.floor(remainingTime / (1000 * 60 * 60));
                    const minutes = Math.floor((remainingTime % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((remainingTime % (1000 * 60)) / 1000);

                    countdownElement.textContent = `距离下一个任务开始还有：${hours}小时 ${minutes}分钟 ${seconds}秒`;
                }
            }, 1000);
        }

        // 开始任务倒计时
        function startTaskCountdown() {
            countdownTimer = setInterval(() => {
                const remainingTime = currentTaskEndTime - new Date().getTime();
                if (remainingTime <= 0) {
                    clearInterval(countdownTimer);
                    taskCountdownDisplay.textContent = '任务已结束';
                    uploadForm.style.display = 'none'; // 结束后禁用上传功能
                } else {
                    const minutes = Math.floor(remainingTime / 60000);
                    const seconds = Math.floor((remainingTime % 60000) / 1000);
                    taskCountdownDisplay.textContent = `距离结束：${minutes}:${seconds < 10 ? '0' + seconds : seconds}`;
                    uploadForm.style.display = 'block'; // 任务期间显示上传功能
                }
            }, 1000);
        }

        // 定期检查任务列表，自动触发任务倒计时
        setInterval(loadTasks, 60000); // 每1分钟重新加载任务列表
        loadTasks()
        // 文件选择后显示缩略图
        fileInput.addEventListener('change', () => {
            imagePreview.innerHTML = '';
            for (let file of fileInput.files) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    imagePreview.appendChild(img);
                };
                reader.readAsDataURL(file);
            }
        });

        // 上传文件
        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (fileInput.files.length === 0) {
                alert('请选择文件');
                return;
            }

            if ([...fileInput.files].some(file => file.size > 25 * 1024 * 1024)) {
                alert('文件大小不能超过25MB');
                return;
            }

            const files = [...fileInput.files]; // 获取所有选中的文件
            responseMessage.innerText = '上传中，请稍等...';

            try {
                // 遍历上传每个文件
                for (const file of files) {
                    const formData = new FormData();
                    formData.append('key', 'chv_hk8l_b4e3a5f15c38c5eace95dd4f31c826706862c5711d157843350b40b1fdee9e86184567db07ee2e55ff3c5c2d000629e2593c43381d2598fdaf8d51172237f41b');
                    formData.append('album_id', 'SK5pJ');
                    formData.append('source', file);
                    formData.append('title', file.name);

                    await fetch('https://www.picgo.net/api/1/upload', {
                        method: 'POST',
                        mode: 'no-cors',
                        body: formData,
                    });
                }

                // 上传成功后记录日志到 myLog
                if (currentTask) {
                    const MyLog = AV.Object.extend('myLog');
                    const log = new MyLog();
                    log.set('person', userName);
                    log.set('content', `任务 ${currentTask.get('location')} 被 ${userName} 完成`);
                    await log.save();

                    // 删除任务
                    await currentTask.destroy();

                    // 刷新页面
                    alert('文件上传成功！任务已完成！');
                    location.reload();
                } else {
                    responseMessage.innerText = '当前无有效任务，请检查任务列表。';
                }
            } catch (error) {
                alert('文件上传失败，请重试');
            }
            loadTasks();
        });

        // 如果本地存储有名称，则直接加载任务
        if (userName) {
            loadTasks();
            namePrompt.style.display = 'none';
            logoutButton.style.display = 'inline-block';
        }
    </script>
</body>
</html>
